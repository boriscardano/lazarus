# Git Integration and PR Creation

This document describes Lazarus's Git integration and automatic PR creation system.

## Overview

Lazarus can automatically create pull requests when it successfully heals a failing script. This enables a review-based workflow where:

1. Lazarus detects a script failure
2. Claude Code analyzes and fixes the issue
3. Changes are committed to a feature branch
4. A PR is created with detailed information
5. Team members can review and merge the fix

## Architecture

### Components

#### GitOperations (`lazarus.git.operations`)

Low-level git operations wrapper using subprocess:

- Branch management (create, checkout, check existence)
- Staging and committing changes
- Pushing to remote
- Repository state queries (current branch, uncommitted changes)
- Default branch detection

#### PRCreator (`lazarus.git.pr`)

High-level PR creation orchestrator:

- PR lifecycle management
- Title and body generation
- GitHub CLI integration
- Prerequisite checking (gh installed, authenticated)
- Existing PR detection

### Data Flow

```
HealingResult (successful)
    â†“
PRCreator.create_pr()
    â†“
â”œâ”€ Check prerequisites (gh CLI, auth)
â”œâ”€ Generate branch name
â”œâ”€ Create/checkout feature branch
â”œâ”€ Push changes to remote
â”œâ”€ Build PR title and body
â””â”€ Create PR via gh CLI
    â†“
PRResult (success, url, number)
```

## Configuration

Configure PR creation in your `lazarus.yaml`:

```yaml
git:
  create_pr: true                    # Enable automatic PR creation
  branch_prefix: "lazarus/fix"       # Branch name prefix
  draft_pr: false                    # Create as draft PR
  auto_merge: false                  # Enable auto-merge (not implemented yet)

  # Optional templates
  commit_message_template: "fix: heal {script_name}"
  pr_title_template: "fix(lazarus): heal {script_name}"
  pr_body_template: |
    Custom PR body template
    Script: {script_path}
    Attempts: {attempts}
```

### Branch Naming

Default format: `{branch_prefix}/{script_name}`

Examples:
- `lazarus/fix/backup` (from backup.py)
- `lazarus/fix/database-sync` (from database_sync.py)

### PR Title Format

Default: `fix(lazarus): heal {script_name}`

Examples:
- `fix(lazarus): heal backup.py`
- `fix(lazarus): heal data-processor.py`

### PR Body Structure

```markdown
## Summary

Lazarus automatically healed `script.py` after detecting a failure.

### Healing Details

- **Script**: `scripts/backup.py`
- **Attempts**: 2
- **Duration**: 15.3s
- **Status**: âœ… Success

### Original Error

```
ImportError: No module named 'requests'
```

### Changes Made

Claude Code analyzed the error and made the following changes:

**Attempt 1**: same_error
**Attempt 2**: success

### Test Instructions

To verify this fix:

1. Checkout this branch
2. Run the script: `scripts/backup.py`
3. Verify it completes successfully

---

ðŸ¤– *This PR was automatically generated by Lazarus using Claude Code*
```

## Prerequisites

### GitHub CLI (gh)

Install the GitHub CLI:

```bash
# macOS
brew install gh

# Linux
sudo apt install gh

# Windows
winget install GitHub.cli
```

Authenticate with GitHub:

```bash
gh auth login
```

### Git Configuration

Ensure git is configured with your identity:

```bash
git config --global user.name "Your Name"
git config --global user.email "you@example.com"
```

## Usage

### Automatic (Recommended)

Set `git.create_pr: true` in your config. Lazarus will automatically:

1. Create a feature branch after successful healing
2. Commit the changes
3. Push to remote
4. Create a PR

### Manual

Use the PRCreator class directly:

```python
from pathlib import Path
from lazarus.config.schema import GitConfig
from lazarus.git.pr import PRCreator

config = GitConfig(
    create_pr=True,
    branch_prefix="lazarus/fix",
)

pr_creator = PRCreator(config, repo_path=Path.cwd())

# Check prerequisites
if not pr_creator.is_gh_available():
    print("GitHub CLI not installed")
if not pr_creator.is_gh_authenticated():
    print("Not authenticated with GitHub")

# Create PR from healing result
result = pr_creator.create_pr(healing_result, script_path)

if result.success:
    print(f"PR created: {result.pr_url}")
else:
    print(f"Failed: {result.error_message}")
```

## Workflow Examples

### Basic Workflow

1. Script fails during monitoring
2. Lazarus heals it successfully
3. PR is created on `lazarus/fix/script-name` branch
4. Team reviews and merges
5. CI runs tests on the PR

### Branch Already Exists

If the branch already exists:

1. Lazarus checks for existing PR
2. If PR exists, returns the existing PR URL
3. If no PR exists, uses the existing branch and creates PR

### On Default Branch

If Lazarus runs on the default branch (main/master):

1. Creates a new feature branch
2. Makes changes on the feature branch
3. Pushes and creates PR

### On Feature Branch

If already on a feature branch:

1. Uses the current branch
2. Pushes changes
3. Creates PR from current branch to default branch

## Error Handling

### GitHub CLI Not Available

```
PRResult(
    success=False,
    error_message="GitHub CLI (gh) is not installed. Install it from https://cli.github.com/"
)
```

### Not Authenticated

```
PRResult(
    success=False,
    error_message="GitHub CLI is not authenticated. Run: gh auth login"
)
```

### Push Failed

If pushing to remote fails (e.g., permission issues):

```
PRResult(
    success=False,
    error_message="Failed to push: Permission denied"
)
```

### PR Already Exists

```
PRResult(
    success=True,
    pr_url="https://github.com/owner/repo/pull/123",
    error_message="PR already exists for this branch"
)
```

## Security Considerations

### Sensitive Information

PRCreator includes basic redaction for PR bodies:

- API keys (patterns > 20 chars)
- Passwords in environment variables
- Bearer tokens

For comprehensive redaction, healing context is processed by the security module before reaching PRCreator.

### Permissions

Ensure the GitHub token has sufficient permissions:

- `repo` scope for creating PRs
- `workflow` scope if PR triggers GitHub Actions

Check current scopes:

```bash
gh auth status
```

Refresh authentication if needed:

```bash
gh auth refresh -s repo -s workflow
```

## Troubleshooting

### "Not a git repository"

Ensure Lazarus runs in a git repository:

```bash
git init
git remote add origin <your-repo-url>
```

### "gh: command not found"

Install GitHub CLI:

```bash
brew install gh  # macOS
```

### "failed to push some refs"

Ensure remote is configured and accessible:

```bash
git remote -v
gh auth status
```

### "refusing to allow a GitHub App to create a pull request"

If using GitHub App authentication, ensure the app has PR creation permissions.

## Advanced Features

### Draft PRs

Create PRs as drafts for review before marking ready:

```yaml
git:
  draft_pr: true
```

### Labels and Assignees

Configure in the GitConfig (not yet implemented):

```yaml
git:
  labels: ["lazarus", "auto-heal", "needs-review"]
  assignees: ["team-lead"]
```

### Custom Templates

Use Jinja2-style templates for customization:

```yaml
git:
  pr_body_template: |
    ## ðŸ”§ Auto-Healing Report

    Script: `{script_path}`
    Healing Time: {duration:.2f}s
    Attempts: {attempts}

    Review and merge if tests pass.
```

## Integration with CI/CD

### GitHub Actions

Lazarus PRs can trigger GitHub Actions workflows:

```yaml
name: Test Lazarus PR
on:
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: pytest
```

### Auto-merge

Enable auto-merge on PRs that pass checks (requires GitHub Actions):

```yaml
git:
  auto_merge: true  # Not yet implemented
```

This requires:
1. Branch protection rules
2. Required status checks
3. GitHub Actions workflow

## API Reference

See inline documentation in:
- `src/lazarus/git/operations.py` - GitOperations class
- `src/lazarus/git/pr.py` - PRCreator class

## Examples

See `examples/pr_creation_example.py` for a complete demonstration.
